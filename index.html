<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.85">
  <meta name="description" content="è¨ˆç®—ã§åŠ é€Ÿï¼èµ°ã‚Šç¶šã‘ã‚‹è„³ãƒˆãƒ¬ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚²ãƒ¼ãƒ  - è¨ˆç®—ç–¾èµ°ï¼RUNÃ—ç®—">
  <title>è¨ˆç®—ç–¾èµ°ï¼RUNÃ—ç®—</title>
  <link rel="stylesheet" href="style.css">
</head>
<style>
    body { font-family: sans-serif; background: #eef; text-align: center; margin: 0; overflow: hidden; }
    /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ */
    #title-screen {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #e0f7fa;
    }
    #title-screen h1 {
        font-size: 50px;
        color: #333;
    }
    #start-button {
        margin-top: 20px;
        padding: 15px 30px;
        font-size: 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    #start-button:hover {
        background-color: #45a049;
    }
    #ranking-list {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding-left: 0;
        list-style: none;
    }
    #ranking-list li {
        margin: 6px 0;
        font-size: 16px;
        font-weight: bold;
        color: #333;
    }
    #ranking-modal button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 18px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    #ranking-modal button:hover {
        background: #45a049;
    }
    #game {
    position: relative;
    aspect-ratio: 8 / 3; /* â† 800:300 ã®æ¯”ç‡ */
    width: 800px;    
    background: url('ä¸Šç©º.jpg') repeat-x center center;
    background-size: cover;
    border: 2px solid #000;
    margin: 20px auto;
    overflow: hidden;
    background-position: 0 0;
    }

    #game.fade {
        transition: opacity 0.3s ease;
        opacity: 0;
    }
    #lives {
        height: 40px; /* è¡¨ç¤ºä¸­ã®ãƒãƒ¼ãƒˆã®é«˜ã•ãã‚‰ã„ã«åˆã‚ã›ã‚‹ */
        font-size: 24px;
        line-height: 40px;
    }
    .lane {
        position: absolute; width: 100%; height: 100px; border-top: 1px solid #ccc;
    }
    #player {
        position: absolute; 
        left: 50px; 
        width: 50px; 
        height: 50px;
        background: url('type_zero_anf.gif') no-repeat center center;
        background-size: 90%; /* GIFç”»åƒãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚µã‚¤ã‚ºã«ãƒ•ã‚£ãƒƒãƒˆã™ã‚‹ã‚ˆã†ã« */
        transition: top 0.1s;
    }
    .obstacle {
        position: absolute;
        width: 100px;
        height: 50px;
        background: rgba(173, 216, 230, 0.85); /* åŠé€æ˜ã®æ°´è‰² */
        font-size: 22px;                       /* å°‘ã—å¤§ãã */
        text-align: center;
        line-height: 50px;
        font-weight: bold;
        font-family: "Consolas", "Courier New", monospace;
        transform: translateZ(0);
        will-change: transform;
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;

        /* å¢ƒç•Œã‚’ã¯ã£ãã‚Šã•ã›ã‚‹ */
        border: 2px solid #007acc;
        border-radius: 8px;

        /* å½±ã‚’ã¤ã‘ã¦è¦–èªæ€§UP */
        box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);

        /* æ–‡å­—ã«ã‚‚å½±ã‚’è¿½åŠ ã—ã¦æ˜ç­ã« */
        color: #fff;
        text-shadow: 1px 1px 2px #000;
    }
    #target {
    font-size: 36px;
    color: #d32f2f; /* èµ¤ç³»ã§ç›®ç«‹ã¤ */
    font-weight: bold;
    padding: 0 10px;
    border-radius: 5px;
    }
    #question {
        font-size: 24px; margin-top: 10px;
    }
    .game {
        transition: opacity 1.5s ease-out, background-image 1.5s ease-out;
        will-change: opacity, background-image;
    }

    /* å¿…è¦ã«å¿œã˜ã¦ãƒ•ã‚§ãƒ¼ãƒ‰ç”¨ã®è¿½åŠ ã‚¯ãƒ©ã‚¹ï¼ˆç¾åœ¨ã®å®Ÿè£…ã‚’æ´»ã‹ã™å ´åˆï¼‰ */
    .fade {
        opacity: 0.7;
        transition: opacity 0.3s ease-in-out;
    }
    #score {
        font-size: 18px;
    }
    /* ã‚³ãƒ³ãƒœã‚²ãƒ¼ã‚¸å…¨ä½“ */
    #combo-bar-container {
        width: 300px;
        height: 25px;
        background-color: #ccc;
        border-radius: 15px;
        margin: 10px auto;
        overflow: hidden;
        border: 2px solid #333;
    }

    /* å®Ÿéš›ã«ä¼¸ã³ã‚‹ã‚²ãƒ¼ã‚¸ */
    #combo-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4CAF50, #8BC34A);
        transition: width 0.2s ease;
    }
    @keyframes flashCombo {
    0%, 100% { background-color: #4CAF50; }
    50% { background-color: gold; }
    }
    .combo-flash {
        animation: flashCombo 0.5s ease;
    }

</style>
<body>

    <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
    <div id="title-screen">
        <h1>è¨ˆç®—ç–¾èµ°ï¼RUNÃ—ç®—</h1>
        <button id="start-button">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="adult-mode-button" style="margin-top: 10px; padding: 15px 30px; font-size: 20px; background-color: #f44336; color: white; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.3s;">ã‚ªãƒˆãƒŠãƒ¢ãƒ¼ãƒ‰</button>
        <!-- ã‚¹ã‚­ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="skin-select" style="margin-top: 20px;">
            <p style="font-size: 20px;">ã‚¹ã‚­ãƒ³ã‚’é¸ã¼ã†ï¼</p>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <img src="type_zero_anf.gif" class="skin-option" onclick="selectSkin('type_zero_anf.gif')" style="width:80px; height:80px; cursor:pointer; border:2px solid transparent; border-radius:10px;">
                <img src="fighter_3body_an.gif" class="skin-option" onclick="selectSkin('fighter_3body_an.gif')" style="width:80px; height:80px; cursor:pointer; border:2px solid transparent; border-radius:10px;">
                <img src="fighter_f104_an.gif" class="skin-option" onclick="selectSkin('fighter_f104_an.gif')" style="width:80px; height:80px; cursor:pointer; border:2px solid transparent; border-radius:10px;">
                <img src="bird18.gif" class="skin-option" onclick="selectSkin('bird18.gif')" style="width:80px; height:80px; cursor:pointer; border:2px solid transparent; border-radius:10px;">
                <img src="karasu.gif" class="skin-option" onclick="selectSkin('karasu.gif')" style="width:80px; height:80px; cursor:pointer; border:2px solid transparent; border-radius:10px;">
                <!-- <img src="chiken.gif" class="skin-option" onclick="selectSkin('chiken.gif')" style="width:80px; height:80px; cursor:pointer; border:2px solid transparent; border-radius:10px;">
                <img src="dog.gif" class="skin-option" onclick="selectSkin('dog.gif')" style="width:80px; height:80px; cursor:pointer; border:2px solid transparent; border-radius:10px;"> -->
                <img src="angel.gif" class="skin-option" onclick="selectSkin('angel.gif')" style="width:80px; height:80px; cursor:pointer; border:2px solid transparent; border-radius:10px;">
                <img src="ufo.gif" class="skin-option" onclick="selectSkin('ufo.gif')" style="width:80px; height:80px; cursor:pointer; border:2px solid transparent; border-radius:10px;">
            </div>
        </div>
    </div>
    
<!-- BGMã¨SEã‚’ã“ã“ã«ã¾ã¨ã‚ã¦é…ç½® -->
<audio id="bgm" src="8ãƒ“ãƒƒãƒˆã®å†’é™º.mp3" loop></audio>
<audio id="se-correct" src="æ±ºå®šãƒœã‚¿ãƒ³ã‚’æŠ¼ã™53.mp3"></audio>
<audio id="se-wrong" src="ãƒ“ãƒ¼ãƒ—éŸ³4.mp3"></audio>

<h1>â†‘â†“ã§ãƒ¬ãƒ¼ãƒ³ç§»å‹•ï¼</h1>
<div id="question">ç­”ãˆãŒ <span id="target">?</span> ã«ãªã‚‹å¼ã‚’é¸ã¼ã†ï¼</div>
<div id="distance" style="font-size: 18px; margin-top: 5px;">00000m</div>
<div id="lives">â¤ï¸â¤ï¸â¤ï¸</div>
<div id="combo-bar-container">
    <div id="combo-bar"></div>
</div>
<div id="game">
    <div id="player"></div>
    <div id="ranking-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
        background:white; padding:30px; border:2px solid #000; border-radius:20px; z-index:1000;">
        <h2>ğŸ GAME OVERï¼</h2>
        <p id="final-score">ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: 0</p>
        <h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        <ol id="ranking-list" style="text-align:left; padding-left: 20px;"></ol>
        <button onclick="restartGame()">ãƒªãƒˆãƒ©ã‚¤</button>
        <button onclick="returnToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã«æˆ»ã‚‹</button>
    </div>
</div>


<!-- èƒŒæ™¯ã¼ã‹ã—ç”¨ -->
<div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); z-index:1000;"></div>

<script>
const game = document.getElementById("game");
const player = document.getElementById("player");
const targetSpan = document.getElementById("target");
const livesDisplay = document.getElementById("lives");

const bgm = document.getElementById("bgm");
const seCorrect = document.getElementById("se-correct");
const seWrong = document.getElementById("se-wrong");

const lanes = [25, 125, 225]; // Yåº§æ¨™
const backgrounds = [
    "ä¸Šç©º.jpg", "å¤•æ–¹.jpg", "å¤œ.jpg"
];
let backgroundIndex = 0;
let currentLane = 1;
let speed = 2;
let score = 0;
let targetAnswer = 0;
let lives = 3;
let isSpawning = false;
let hasAnswered = false;
let started = false; // BGMå†ç”Ÿãƒ•ãƒ©ã‚°
// â–¼ èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
let bgPos = 0;
let distance = 0; // ç§»å‹•è·é›¢
setInterval(() => {
    // èƒŒæ™¯ç§»å‹•
    bgPos -= speed / 2;
    game.style.backgroundPosition = `${bgPos}px 0`;

    // è·é›¢åŠ ç®—ï¼ˆspeedã«æ¯”ä¾‹ï¼‰
    distance += speed  * 0.01;
    const formattedDistance = Math.floor(distance).toString().padStart(5, '0') + 'm';
    document.getElementById('distance').textContent = formattedDistance;

}, 20);

let selectedSkin = 'type_zero_anf.gif'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
function selectSkin(skinFile) {
    selectedSkin = skinFile;
    player.style.backgroundImage = `url('${selectedSkin}')`;

    // å…¨éƒ¨ãƒªã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰é¸ã‚“ã ã‚„ã¤ã ã‘æ ç·šã¤ã‘ã‚‹
    document.querySelectorAll('.skin-option').forEach(img => {
        img.style.border = '2px solid transparent';
    });
    const selectedImg = Array.from(document.querySelectorAll('.skin-option')).find(img => img.src.includes(skinFile));
    if (selectedImg) {
        selectedImg.style.border = '2px solid #4CAF50';
    }
}

player.style.top = lanes[currentLane] + "px";

// // â–¼ æœ€åˆã®ã‚­ãƒ¼æŠ¼ã—ã§BGMå†ç”Ÿï¼‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•
// document.addEventListener("keydown", (e) => {
//     if (!started) {
//         bgm.volume = 0.1;
//         bgm.play().catch(e => console.log("BGMå†ç”Ÿå¤±æ•—", e));
//         started = true;
//     }
//     if (e.key === "ArrowUp" && currentLane > 0) {
//         currentLane--;
//     } else if (e.key === "ArrowDown" && currentLane < 2) {
//         currentLane++;
//     }
//     player.style.top = lanes[currentLane] + "px";
// });
// â–¼ æœ€åˆã®ã‚­ãƒ¼æŠ¼ã—ã§BGMå†ç”Ÿï¼‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹• (æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰)
document.addEventListener("keydown", (e) => {
    // ã‚²ãƒ¼ãƒ ãŒã¾ã å§‹ã¾ã£ã¦ã„ãªã„å ´åˆã€BGMã‚’å†ç”Ÿ
    // ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼ã‚’è€ƒæ…®ã—ã€ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚åŒæ§˜ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™
    if (!started) {
        bgm.volume = 0.1;
        // BGMå†ç”Ÿã«å¤±æ•—ã—ãŸå ´åˆã®ãƒ­ã‚°å‡ºåŠ›
        bgm.play().catch(error => console.log("BGMå†ç”Ÿå¤±æ•—:", error));
        started = true;
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®çŸ¢å°ã‚­ãƒ¼ã§ãƒ¬ãƒ¼ãƒ³ã‚’ç§»å‹•
    if (e.key === "ArrowUp" && currentLane > 0) {
        currentLane--; // ä¸Šæ–¹å‘ã¸ç§»å‹•
    } else if (e.key === "ArrowDown" && currentLane < 2) { // ãƒ¬ãƒ¼ãƒ³ã®æœ€å¤§æ•°ã‚’2ã¨ä»®å®š
        currentLane++; // ä¸‹æ–¹å‘ã¸ç§»å‹•
    }
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¦ç´ ã®ä½ç½®ã‚’æ›´æ–°
    player.style.top = lanes[currentLane] + "px";
});

// --- ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å¯¾å¿œã®ãŸã‚ã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ ---

let touchStartY = 0; // ã‚¿ãƒƒãƒé–‹å§‹æ™‚ã®Yåº§æ¨™ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

// â–¼ ã‚¿ãƒƒãƒé–‹å§‹æ™‚ã®å‡¦ç†
document.addEventListener("touchstart", (e) => {
    // ã‚²ãƒ¼ãƒ ãŒã¾ã å§‹ã¾ã£ã¦ã„ãªã„å ´åˆã€BGMã‚’å†ç”Ÿ
    // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œãŒãªã„ã¨BGMãŒå†ç”Ÿã•ã‚Œãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€ã“ã“ã«ã‚‚è¨˜è¿°
    if (!started) {
        bgm.volume = 0.1;
        bgm.play().catch(error => console.log("BGMå†ç”Ÿå¤±æ•—:", error));
        started = true;
    }
    // æœ€åˆã®æŒ‡ã®ã‚¿ãƒƒãƒä½ç½®ã®Yåº§æ¨™ã‚’è¨˜éŒ²
    touchStartY = e.touches[0].clientY;
});

// â–¼ ã‚¿ãƒƒãƒçµ‚äº†æ™‚ã®å‡¦ç†ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®šï¼‰
document.addEventListener("touchend", (e) => {
    // æŒ‡ã‚’é›¢ã—ãŸæ™‚ã®Yåº§æ¨™ã‚’å–å¾—
    const touchEndY = e.changedTouches[0].clientY;
    // ã‚¹ãƒ¯ã‚¤ãƒ—ã®Yæ–¹å‘ã®ç§»å‹•é‡ã‚’è¨ˆç®—
    const touchDiff = touchEndY - touchStartY;

    // ã‚¹ãƒ¯ã‚¤ãƒ—ã¨èªè­˜ã™ã‚‹ãŸã‚ã®ã—ãã„å€¤ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰ã€‚ã“ã®å€¤ã‚’èª¿æ•´ã—ã¦æ„Ÿåº¦ã‚’å¤‰ãˆã‚‰ã‚Œã¾ã™
    const swipeThreshold = 30;

    // ä¸Šæ–¹å‘ã¸ã®ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®šï¼ˆæŒ‡ã‚’ä¸Šã«å‹•ã‹ã™ã¨Yåº§æ¨™ã¯æ¸›å°‘ã™ã‚‹ï¼‰
    if (touchDiff < -swipeThreshold && currentLane > 0) {
        currentLane--; // ãƒ¬ãƒ¼ãƒ³ã‚’ä¸Šã«ç§»å‹•
    } 
    // ä¸‹æ–¹å‘ã¸ã®ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®šï¼ˆæŒ‡ã‚’ä¸‹ã«å‹•ã‹ã™ã¨Yåº§æ¨™ã¯å¢—åŠ ã™ã‚‹ï¼‰
    else if (touchDiff > swipeThreshold && currentLane < 2) { // ãƒ¬ãƒ¼ãƒ³ã®æœ€å¤§æ•°ã‚’2ã¨ä»®å®š
        currentLane++; // ãƒ¬ãƒ¼ãƒ³ã‚’ä¸‹ã«ç§»å‹•
    }
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¦ç´ ã®ä½ç½®ã‚’æ›´æ–°
    player.style.top = lanes[currentLane] + "px";
});
  
// â–¼ ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³
document.getElementById("start-button").addEventListener("click", function() {
    document.getElementById("title-screen").style.display = "none";
    game.style.display = "block";
    player.style.backgroundImage = `url('${selectedSkin}')`; // â†ã“ã‚Œè¿½åŠ ï¼
    distance = 0;
    isAdultMode = false;
    spawnChallenge();
});
document.getElementById('adult-mode-button').addEventListener('click', () => {
    document.getElementById("title-screen").style.display = "none";
    game.style.display = "block";
    player.style.backgroundImage = `url('${selectedSkin}')`; // â†ã“ã‚Œè¿½åŠ ï¼
    distance = 0;
    isAdultMode = true;
    spawnChallenge(); // startGameé–¢æ•°ã‚’å‘¼ã³å‡ºã™
});

// â–¼ å¼ã‚’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
function generateExpressions() {
    const ops = ["+", "-", "*", "/"];
    const expressions = [];
    if (isAdultMode){
        const a = Math.floor(Math.random() * 50) + 1;
        const b = Math.floor(Math.random() * 50) + 1;
        const op = ops[Math.floor(Math.random() * ops.length)];
        const expr = `${a}${op}${b}`;
        const answer = eval(expr);
        if (op === "/" && a % b !== 0) return generateExpressions(); // å†ç”Ÿæˆ

        targetAnswer = answer;
        expressions.push(expr);

        while (expressions.length < 3) {
            const a2 = Math.floor(Math.random() * 50) + 1;
            const b2 = Math.floor(Math.random() * 50) + 1;
            const op2 = ops[Math.floor(Math.random() * ops.length)];
            const expr2 = `${a2}${op2}${b2}`;
            let res2;
            try { res2 = eval(expr2); } catch { continue; }
            if (res2 !== targetAnswer && Number.isFinite(res2)) {
                expressions.push(expr2);
            }
        }
    }
    else{
        const a = Math.floor(Math.random() * 9) + 1;
        const b = Math.floor(Math.random() * 9) + 1;
        const op = ops[Math.floor(Math.random() * ops.length)];
        const expr = `${a}${op}${b}`;
        const answer = eval(expr);
        if (op === "/" && a % b !== 0) return generateExpressions(); // å†ç”Ÿæˆ
        
        targetAnswer = answer;
        expressions.push(expr);
        
        while (expressions.length < 3) {
            const a2 = Math.floor(Math.random() * 9) + 1;
            const b2 = Math.floor(Math.random() * 9) + 1;
            const op2 = ops[Math.floor(Math.random() * ops.length)];
            const expr2 = `${a2}${op2}${b2}`;
            let res2;
            try { res2 = eval(expr2); } catch { continue; }
            if (res2 !== targetAnswer && Number.isFinite(res2)) {
                expressions.push(expr2);
            }
        }            
    }
    return expressions.sort(() => Math.random() - 0.5);
}

// â–¼ å•é¡Œã‚’å‡ºã™
function spawnChallenge() {
    if (isSpawning) return;
    isSpawning = true;
    hasAnswered = false;

    const expressions = generateExpressions();
    targetSpan.textContent = targetAnswer;

    const correctLane = expressions.findIndex(e => eval(e) === targetAnswer);

    expressions.forEach((expr, i) => {
        const obstacle = document.createElement("div");
        obstacle.className = "obstacle";
        obstacle.textContent = expr.replace('*', 'ï½˜').replace('/', 'ï¼').replace('+', 'ï¼‹').replace('-', 'ãƒ¼');
        obstacle.style.top = lanes[i] + "px";
        obstacle.style.left = "800px";
        game.appendChild(obstacle);

        let pos = 800;
        const move = setInterval(() => {
            pos -= speed;
            obstacle.style.left = pos + "px";

            if (pos < 100 && pos + 100 > 50 && i === currentLane) {
                if (hasAnswered) return;

                hasAnswered = true;
                clearInterval(move);
                game.removeChild(obstacle);

                if (i === correctLane) {
                    score++;
                    combo++;
                    updateComboBar();
                    // 10ã‚³ãƒ³ãƒœã§â¤1å›å¾©ï¼ˆãŸã ã—æœ€å¤§3ã¤ã¾ã§ï¼‰
                    if (combo % 10 === 0 && lives < 3) {
                        lives++;
                        updateHearts();
                        updateLivesDisplay();

                        // ğŸ”¥ ã‚²ãƒ¼ã‚¸ãŒå…‰ã‚‹æ¼”å‡º
                        const bar = document.getElementById("combo-bar");
                        bar.classList.add("combo-flash");
                        setTimeout(() => bar.classList.remove("combo-flash"), 500);
                    }

                    if (score % 2 === 0){
                        speed += (score <= 6) ? 0.45 : (score <= 14) ? 0.38 : (score < 30) ? 0.15 : 0.10;
                        bgm.playbackRate += 0.025;
                    }

                    if (score % 10 === 0) {
                        backgroundIndex = (backgroundIndex + 1) % backgrounds.length;
                        game.style.opacity = 0;
                        
                        // ç”»åƒå¤‰æ›´ã‚’ç¢ºå®Ÿã«è¡Œã†ãŸã‚ã«2ãƒ•ãƒ¬ãƒ¼ãƒ å¾…ã¤
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => {
                                game.style.backgroundImage = `url('${backgrounds[backgroundIndex]}')`;
                                game.style.opacity = 1;
                            });
                        });
                    }
                    seCorrect.currentTime = 0;
                    seCorrect.volume = 0.5;
                    seCorrect.play();
                }
                else {
                    combo = 0;
                    updateComboBar();

                    lives--;
                    updateLivesDisplay();
                    updateHearts();
                    seWrong.currentTime = 0;
                    seWrong.volume = 0.5;
                    seWrong.play();

                    flashPlayerRed();

                    if (lives <= -1) {
                        fadeOutBGM();
                        if (isAdultMode){
                            const normalRankings = updateRanking(distance, false);
                            showRanking(normalRankings);
                        }
                        else{
                            const Adultrankings = updateRanking(distance, true);
                            showRanking(Adultrankings);
                        }
                        return;
                    }
                }
                setTimeout(() => {
                    isSpawning = false;
                    spawnChallenge();
                }, 4 * 1000 / speed); // ã“ã“ã‚’ã—ã£ã‹ã‚Šä¿®æ­£ï¼ï¼
            }
        }, 20);
    });
}

// â–¼ ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³1
function flashPlayerRed(times = 3, interval = 100) {
    let count = 0;
    const flash = () => {
        player.style.filter = count % 2 === 0 ? "brightness(0.4)" : "none";
        count++;
        if (count < times * 2) {
            setTimeout(flash, interval);
        } else {
            player.style.filter = "none";
        }
    };
    flash();
}

// â–¼ ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³2
function updateLivesDisplay() {
    livesDisplay.innerHTML = `${"â¤ï¸".repeat(Math.max(0, lives))}`;
}

// â–¼ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜
function updateRanking(distance, isAdultMode = false) { // isAdultMode å¼•æ•°ã‚’è¿½åŠ 
    const key = isAdultMode ? "adultRankings" : "normalRankings"; // ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦ã‚­ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆ
    
    // localStorage ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€JSONå½¢å¼ã‹ã‚‰JavaScriptã®é…åˆ—ã«å¤‰æ›ã€‚
    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºã®é…åˆ—ã‚’åˆæœŸå€¤ã¨ã™ã‚‹ã€‚
    const data = JSON.parse(localStorage.getItem(key)) || [];
    
    // ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ï¼ˆè·é›¢ï¼‰ã‚’æ•´æ•°ã«å¤‰æ›ã—ã¦é…åˆ—ã«è¿½åŠ 
    data.push(Math.floor(distance));
    
    // ã‚¹ã‚³ã‚¢ã‚’é™é †ï¼ˆé«˜ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
    data.sort((a, b) => b - a);
    
    // ä¸Šä½1000ä»¶ï¼ˆã¾ãŸã¯æŒ‡å®šä»¶æ•°ï¼‰ã«çµã‚Šè¾¼ã¿
    // é€šå¸¸ã¯ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºä»¶æ•°ã«åˆã‚ã›ã¦10ä»¶ç¨‹åº¦ã«ã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã™ã€‚
    const topData = data.slice(0, 1000); 
    
    // æ›´æ–°ã—ãŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ localStorage ã«ä¿å­˜
    localStorage.setItem(key, JSON.stringify(topData));
    
    // æ›´æ–°ã•ã‚ŒãŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
    return topData;
}

function updateHearts() {
    const heart = "â¤ï¸";
    livesDisplay.textContent = heart.repeat(Math.max(0, lives));
}

function showRanking(rankings) {
    const modal = document.getElementById("ranking-modal");
    const finalScore = document.getElementById("final-score");
    const rankingList = document.getElementById("ranking-list");

    // ã‚¹ã‚³ã‚¢ï¼ˆæ•´æ•°ï¼‰ã‚’å–å¾—
    const myScore = Math.floor(distance);

    // è‡ªåˆ†ã®ã‚¹ã‚³ã‚¢ã®é †ä½ã‚’è¨ˆç®—ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‹1ï¼‰
    const myRank = rankings.indexOf(myScore) + 1;

    // ã‚¹ã‚³ã‚¢ã¨é †ä½ã‚’è¡¨ç¤º
    finalScore.textContent = `ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: ${myScore}ï¼ˆ${myRank}ä½ï¼‰`;

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆç”Ÿæˆ
    rankingList.innerHTML = "";
    const medals = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"];

    rankings.slice(0, 5).forEach((d, i) => {
        const li = document.createElement("li");
        if (i < medals.length) {
            li.textContent = `${medals[i]} ${d}`;
        } else  {
            li.textContent = `${i + 1}ä½: ${d}`;
        }
        rankingList.appendChild(li);
    });

    modal.style.display = "block";
}

function restartGame() {
    // ã‚¹ã‚³ã‚¢ãƒ»ãƒ©ã‚¤ãƒ•ãƒ»ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
    score = 0;
    distance = 0;
    speed = 2;
    lives = 3;
    combo = 0;
    if (typeof updateHearts === "function") updateHearts();
    updateLivesDisplay();
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸä½ç½®ã«æˆ»ã™
    currentLane = 1;
    player.style.top = lanes[currentLane] + "px";

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
    document.getElementById("ranking-modal").style.display = "none";

    // ã‚²ãƒ¼ãƒ ç”»é¢ã¯ãã®ã¾ã¾è¦‹ã›ã‚‹
    game.style.display = "block";

    // èƒŒæ™¯ã‚„BGMã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå¿…è¦ãªã‚‰ï¼‰
    bgPos = 0;
    backgroundIndex = 0;
    game.style.backgroundImage = `url('${backgrounds[backgroundIndex]}')`;
    bgm.currentTime = 0;
    bgm.playbackRate = 1;
    bgm.volume = 0.1;
    bgm.play().catch(e => console.log("BGMå†ç”Ÿå¤±æ•—", e));

    started = true; // æœ€åˆã®ã‚­ãƒ¼æŠ¼ã—ãªã—ã§BGMé³´ã‚‰ã™

    isSpawning = false;
    spawnChallenge(); // æ–°ã—ã„å•é¡Œã‚¹ã‚¿ãƒ¼ãƒˆï¼
}

function returnToTitle() {
    // ã‚²ãƒ¼ãƒ ç”»é¢ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éš ã™
    document.getElementById("game").style.display = "none";
    document.getElementById("ranking-modal").style.display = "none";
    
    // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã‚’è¡¨ç¤º
    document.getElementById("title-screen").style.display = "flex";

    // ã‚¹ã‚³ã‚¢ãƒ»ãƒ©ã‚¤ãƒ•ãƒ»ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
    score = 0;
    distance = 0;
    speed = 2;
    lives = 3;
    combo = 0;
    updateHearts();
    updateLivesDisplay();

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸä½ç½®ã«æˆ»ã™
    currentLane = 1;
    player.style.top = lanes[currentLane] + "px";

    // BGMæ­¢ã¾ã£ã¦ãŸã‚‰å†ç”Ÿã§ãã‚‹ã‚ˆã†ã«
    bgPos = 0;
    backgroundIndex = 0;
    game.style.backgroundImage = `url('${backgrounds[backgroundIndex]}')`;
    bgm.pause();
    bgm.currentTime = 0;
    bgm.playbackRate = 1;
    started = false;

    // ğŸ› ï¸ã“ã“è¿½åŠ ï¼
    isSpawning = false;
}

let combo = 0;
function updateComboBar() {
    const bar = document.getElementById("combo-bar");
    const percentage = Math.min((combo % 10) * 10, 100); // 10ã‚³ãƒ³ãƒœã§100%
    bar.style.width = `${percentage}%`;
}

// â–¼ BGMã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå‡¦ç†
function fadeOutBGM() {
    let volume = bgm.volume;
    const fade = setInterval(() => {
        if (volume > 0.01) {
            volume -= 0.01;
            bgm.volume = volume;
        } else {
            clearInterval(fade);
            bgm.pause();
            bgm.currentTime = 0;
        }
    }, 50);
}

</script>
</body>
</html>
